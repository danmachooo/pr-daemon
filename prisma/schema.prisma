generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Team {
  id   Int    @id @default(autoincrement())
  name String

  // Slack integration (store encrypted string in app layer)
  slackWebhookUrlEnc String?

  // GitHub webhook verification secret (store hashed OR encrypted)
  githubWebhookSecretEnc String?

  // Rule thresholds + toggles (json for now; can normalize later)
  configs Json @default("{}")

  // Health / verification (for UI status)
  lastGithubEventAt DateTime?
  lastSlackSentAt   DateTime?
  lastRuleRunAt     DateTime?
  lastRuleErrorAt   DateTime?
  // Ownership + membership
  ownerId           String
  owner             User         @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members           TeamMember[]

  // GitHub org selection (optional)
  githubOrgId    Int?
  githubOrgLogin String?

  repositories Repository[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId])
}

model TeamMember {
  id     Int      @id @default(autoincrement())
  teamId Int
  userId String
  role   TeamRole @default(MEMBER)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  MEMBER
}

model Repository {
  id       Int    @id // GitHub repository ID
  name     String
  fullName String // "org/repo" for display + uniqueness
  teamId   Int
  team     Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  pullRequests PullRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, fullName])
  @@index([teamId])
}

model PullRequest {
  id       Int      @id @default(autoincrement())
  repoId   Int
  prNumber Int
  title    String
  status   PRStatus

  openedAt DateTime
  closedAt DateTime?

  staleAlertAt DateTime?

  reviewCount       Int       @default(0)
  lastReviewAt      DateTime?
  unreviewedAlertAt DateTime?
  lastCommitAt      DateTime?
  stalledAlertAt    DateTime?

  reviewers          Json?
  completedReviewers Json?

  repository Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, prNumber])
  @@index([repoId])
}

enum PRStatus {
  OPEN
  CLOSED
}

// ---------- Better Auth tables (kept) ----------

model User {
  id            String   @id
  name          String
  email         String
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions Session[]
  accounts Account[]

  // Team relationships
  ownedTeams  Team[]       @relation("TeamOwner")
  memberships TeamMember[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
